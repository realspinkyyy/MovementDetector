<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Piano Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #111;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #222;
    }

    .header h1 {
      font-size: 20px;
      margin: 0;
    }

    #settingsBtn {
      background: #00ff88;
      border: none;
      padding: 6px 12px;
      color: black;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    #settingsPanel {
      display: none;
      background: #222;
      padding: 15px;
      border-top: 2px solid #00ff88;
    }

    .section {
      margin-bottom: 10px;
    }

    .section label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .piano {
      display: flex;
      justify-content: center;
      flex-wrap: nowrap;
      position: relative;
      height: 200px;
      user-select: none;
    }

    .key {
      width: 50px;
      height: 100%;
      background: white;
      border: 1px solid #ccc;
      margin: 0 1px;
      box-shadow: 0 2px 3px rgba(0,0,0,0.4);
      position: relative;
      z-index: 1;
    }

    .key.black {
      width: 30px;
      height: 130px;
      background: black;
      position: absolute;
      margin: 0;
      z-index: 2;
      top: 0;
    }

    .key.active {
      background: #00ff88 !important;
    }

    .controls {
      display: flex;
      gap: 20px;
      padding: 10px 20px;
      align-items: center;
      background: #111;
    }

    select, input[type="range"] {
      padding: 5px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
    }

    #console {
      background: #000;
      color: #00ff88;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      max-height: 120px;
      overflow-y: auto;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Mini Piano Studio</h1>
    <button id="settingsBtn">Settings</button>
  </div>

  <div id="settingsPanel">
    <div class="section">
      <label>Pitch</label>
      <input type="range" id="pitchSlider" min="0.5" max="2" step="0.01" value="1">
    </div>
    <div class="section">
      <label>Voice</label>
      <select id="voiceSelect"></select>
    </div>
    <div class="section">
      <label>Debug Console</label>
      <div id="console">Console initialized...</div>
    </div>
  </div>

  <div class="piano" id="piano"></div>

  <div class="controls">
    <label>Pitch: <span id="pitchValue">1.0×</span></label>
  </div>

  <script>
    const notes = [
      { note: "C", key: "C" },
      { note: "C#", key: "C#", black: true, offset: 35 },
      { note: "D", key: "D" },
      { note: "D#", key: "D#", black: true, offset: 85 },
      { note: "E", key: "E" },
      { note: "F", key: "F" },
      { note: "F#", key: "F#", black: true, offset: 185 },
      { note: "G", key: "G" },
      { note: "G#", key: "G#", black: true, offset: 235 },
      { note: "A", key: "A" },
      { note: "A#", key: "A#", black: true, offset: 285 },
      { note: "B", key: "B" },
      { note: "C2", key: "C2" }
    ];

    const synth = window.speechSynthesis;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let currentPitch = 1;
    let currentVoice = null;

    const pianoEl = document.getElementById("piano");
    const pitchSlider = document.getElementById("pitchSlider");
    const pitchValue = document.getElementById("pitchValue");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsPanel = document.getElementById("settingsPanel");
    const consoleEl = document.getElementById("console");
    const voiceSelect = document.getElementById("voiceSelect");

    // Create keys
    notes.forEach((n, i) => {
      if (n.black) return;
      const key = document.createElement("div");
      key.className = "key";
      key.dataset.note = n.note;
      pianoEl.appendChild(key);
    });

    // Add black keys manually
    notes.forEach(n => {
      if (n.black) {
        const key = document.createElement("div");
        key.className = "key black";
        key.dataset.note = n.note;
        key.style.left = n.offset + "px";
        pianoEl.appendChild(key);
      }
    });

    function playNote(note) {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      const freq = getFrequency(note);
      osc.frequency.setValueAtTime(freq * currentPitch, ctx.currentTime);
      osc.type = "sine";
      osc.connect(gain);
      gain.connect(ctx.destination);
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      osc.start();
      osc.stop(ctx.currentTime + 1);
      log(`Playing ${note} at pitch ${currentPitch}`);
    }

    function getFrequency(note) {
      const frequencies = {
        "C": 261.63, "C#": 277.18, "D": 293.66, "D#": 311.13,
        "E": 329.63, "F": 349.23, "F#": 369.99, "G": 392.00,
        "G#": 415.30, "A": 440.00, "A#": 466.16, "B": 493.88,
        "C2": 523.25
      };
      return frequencies[note];
    }

    function log(msg) {
      consoleEl.innerHTML += `<div>> ${msg}</div>`;
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    pianoEl.addEventListener("mousedown", e => {
      if (e.target.classList.contains("key")) {
        e.target.classList.add("active");
        playNote(e.target.dataset.note);
      }
    });

    pianoEl.addEventListener("mouseup", e => {
      if (e.target.classList.contains("key")) {
        e.target.classList.remove("active");
      }
    });

    pitchSlider.addEventListener("input", () => {
      currentPitch = parseFloat(pitchSlider.value);
      pitchValue.textContent = currentPitch.toFixed(2) + "×";
      log("Pitch slider is working");
    });

    settingsBtn.addEventListener("click", () => {
      settingsPanel.style.display = settingsPanel.style.display === "block" ? "none" : "block";
    });

    // Load voices
    function populateVoices() {
      const voices = synth.getVoices();
      voiceSelect.innerHTML = '';
      voices.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.name;
        opt.textContent = v.name;
        voiceSelect.appendChild(opt);
      });
      log("Voices loaded");
    }

    voiceSelect.addEventListener("change", () => {
      currentVoice = synth.getVoices().find(v => v.name === voiceSelect.value);
      log("Voice changed to " + currentVoice.name);
    });

    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = populateVoices;
    } else {
      populateVoices();
    }
  </script>
</body>
</html>
